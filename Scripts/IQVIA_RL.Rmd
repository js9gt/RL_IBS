---
title: "EDA"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(lubridate)
library(dplyr)
library(ggplot2)


#Read in excel file
ibs_dat <- read_excel("~/Desktop/RL_IBS/ibs_dat.xlsx", skip = 1)
```


```{r}
## dimensions-- 500 total claims
dim(ibs_dat)

## unique date in year-month-date-- 88 unique dates
length(unique(ibs_dat$from_dt))

## unique claim codes-- 155 
length(unique(ibs_dat$claimno))

## unique procedure descriptions-- 142
length(unique(ibs_dat$PROCEDURE_DESC))
```

```{r}
#sort from least recent to most recent
#ibs_dat %>% arrange(ymd(ibs_dat$from_dt))

## The database does not consistently capture drug therapy administered during an inpatient confinement. This is based on how the treatments are billed. we may receive only revenue codes indicating drugs were administered. 
```

```{r}
## First group by date, then tally the number of claims for each date

######## Question to ask: are we more interested in looking at the unique claims? What does it mean for two entries to have the same claim number on the same treatment day?


### unique claims & counts per date
unique_claim_counts <- ibs_dat %>% arrange(ymd(ibs_dat$from_dt)) %>%
                 group_by(from_dt, claimno) %>%
                 tally

## Create plot with unique "from_dt" as x-axis, number of TOTAL claims as y-axis
########## This graph isn't that helpful and needs to be broken down 
ggplot(data = unique_claim_counts, aes(x = from_dt, y = n)) +
      geom_bar(stat = "identity", fill = "purple") +
      labs(title ="Total Number of Claims (non-unique) per visit date",
           x = "Date", y = "Number of (non-unique) Claims")

## Plot with date on y axis, number of unique visits per YEAR-- isolate distinct from_dt and count 
### However, this visualization will count a single hospitalization as multiple visits since those are over multiple days
## Question   1. 

unique_visits_year <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year) %>% tally

ggplot(data = unique_visits_year, aes(x = year, y = n, group = 1)) +
      geom_point() + geom_line(linetype=2) +
      labs(title ="Total Number of Unique Visits per Year",
           x = "Year", y = "Number of Visits")

## We can also group these by month from year to year
unique_visits_month <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year, month) %>% tally


ggplot(data = unique_visits_month, aes(x = month, y = n, group = 1)) +
      facet_wrap(~year) + geom_point() + geom_line(linetype=2) +
      labs(title ="Unique Visits Each Month by Year",
           x = "Year", y = "Number of Visits")


### This doesn't seem to be that informative either. We can see an increasing trend in visits in 2012, also bunch in July of 2011-- maybe these are hospitalizations? 
### From the code below we can see that IS the case. There were only 3 unique hospitalizations, all in 2011 

ibs_dat[!is.na(ibs_dat[,"conf_num"]),] %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year, month, conf_num) %>% tally
```

Build a timeline for hospitalizations-- count number of hospitalizations throughout time frame
```{r}
### count number of hospitalizations throughout time frame
#All of the claims with the same patient ID and confinement number belong to the same unique inpatient stay-- unique hospitalizations

### 3 unique hospitalizations for THIS specific patient 
unique(ibs_dat$conf_num)

### visualize hospitalizations, get count of claims per date per unique hospitalization by year & month
hosp_time <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>%
                 group_by(conf_num, year, month) %>%
                 tally()
 
ggplot(data = hosp_time[hosp_time$year == 2011, ], aes(x = month, y = n, fill = conf_num)) + geom_bar(stat='identity') +
      labs(title ="Unique Visits by Month in 2011",
           x = "Year", y = "Unique visits per month")


### count length of hospitalization throughout time frame 
##### Flawed approac-- actually need to look at first & last day

ibs_dat %>% group_by(conf_num) %>% summarise(distinct_days = n_distinct(from_dt))

length(unique(ibs_dat$from_dt))
```

Starting to group together bloodwork, imaging, surgery, colonoscopy, prescription claims
```{r}
events_timeline_procedure <- ibs_dat %>% 
  # IBS-- need to include this separately because of possibility of overwriting
  #mutate(event_type = ifelse(Primary_diag == "Irritable Bowel Syndrome", "IBS_diagnosis", NA)) %>%
  
  ### Create event_type as column of NAs
  mutate(event_type = NA) %>%
  
  mutate(event_type = case_when(
    grepl("emergency department", PROCEDURE_DESC, ignore.case = TRUE) ~ "ED_visit",
    grepl("colonoscopy", PROCEDURE_DESC, ignore.case = TRUE) ~ "colonoscopy",
    grepl("Esophagogastroduodenoscopy", 
          PROCEDURE_DESC, ignore.case = TRUE) ~ "esophagogastroduodenoscopy",
    (grepl("Enterectomy", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("Enterostomy", PROCEDURE_DESC, ignore.case = TRUE)) ~ "surgery",
    (grepl("ultrasound", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("tomography", PROCEDURE_DESC, ignore.case = TRUE) ~ "imaging")))


## Create new column called "group"
ibs_dat$group <- 0

## we know prescription claims have NDC codes-- for anything with an NDC code, rewrite that as the "prescription" group
ibs_dat %>%
  mutate(group = ifelse(!is.na(ndc), "prescription", group)) %>%

## group the labs
  mutate(group = case_when(
     (grepl("blood count", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("urinalysis", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("metabolic panel", PROCEDURE_DESC, ignore.case = TRUE) ~ "labs"))

```


