---
title: "EDA"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(lubridate)
library(dplyr)
library(ggplot2)


#Read in excel file
ibs_dat <- read_excel("~/Desktop/RL_IBS/ibs_dat.xlsx", skip = 1)
```


```{r}
## dimensions-- 500 total claims
dim(ibs_dat)

## unique date in year-month-date-- 88 unique dates
length(unique(ibs_dat$from_dt))

## unique claim codes-- 155 
length(unique(ibs_dat$claimno))

## unique procedure descriptions-- 142
length(unique(ibs_dat$PROCEDURE_DESC))
```

```{r}
#sort from least recent to most recent
#ibs_dat %>% arrange(ymd(ibs_dat$from_dt))

## The database does not consistently capture drug therapy administered during an inpatient confinement. This is based on how the treatments are billed. we may receive only revenue codes indicating drugs were administered. 
```

```{r}
## First group by date, then tally the number of claims for each date

######## Question to ask: are we more interested in looking at the unique claims? What does it mean for two entries to have the same claim number on the same treatment day?


### unique claims & counts per date
unique_claim_counts <- ibs_dat %>% arrange(ymd(ibs_dat$from_dt)) %>%
                 group_by(from_dt, claimno) %>%
                 tally

## Create plot with unique "from_dt" as x-axis, number of TOTAL claims as y-axis
########## This graph isn't that helpful and needs to be broken down 
ggplot(data = unique_claim_counts, aes(x = from_dt, y = n)) +
      geom_bar(stat = "identity", fill = "purple") +
      labs(title ="Total Number of Claims (non-unique) per visit date",
           x = "Date", y = "Number of (non-unique) Claims")

## Plot with date on y axis, number of unique visits per YEAR-- isolate distinct from_dt and count 
### However, this visualization will count a single hospitalization as multiple visits since those are over multiple days
## Question   1. 

unique_visits_year <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year) %>% tally

ggplot(data = unique_visits_year, aes(x = year, y = n, group = 1)) +
      geom_point() + geom_line(linetype=2) +
      labs(title ="Total Number of Unique Visits per Year",
           x = "Year", y = "Number of Visits")

## We can also group these by month from year to year
unique_visits_month <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year, month) %>% tally


ggplot(data = unique_visits_month, aes(x = month, y = n, group = 1)) +
      facet_wrap(~year) + geom_point() + geom_line(linetype=2) +
      labs(title ="Unique Visits Each Month by Year",
           x = "Year", y = "Number of Visits")


### This doesn't seem to be that informative either. We can see an increasing trend in visits in 2012, also bunch in July of 2011-- maybe these are hospitalizations? 
### From the code below we can see that IS the case. There were only 3 unique hospitalizations, all in 2011 

ibs_dat[!is.na(ibs_dat[,"conf_num"]),] %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>% group_by(year, month, conf_num) %>% tally
```

Build a timeline for hospitalizations-- count number of hospitalizations throughout time frame
```{r}
### count number of hospitalizations throughout time frame
#All of the claims with the same patient ID and confinement number belong to the same unique inpatient stay-- unique hospitalizations

### 3 unique hospitalizations for THIS specific patient 
unique(ibs_dat$conf_num)

### visualize hospitalizations, get count of claims per date per unique hospitalization by year & month
hosp_time <- ibs_dat %>% distinct(from_dt, .keep_all = TRUE) %>% mutate(month = format(from_dt, "%m"),
                                                           year = format(from_dt, "%Y")) %>%
                 group_by(conf_num, year, month) %>%
                 tally()
 
ggplot(data = hosp_time[hosp_time$year == 2011, ], aes(x = month, y = n, fill = conf_num)) + geom_bar(stat='identity') +
      labs(title ="Unique Visits by Month in 2011",
           x = "Year", y = "Unique visits per month")


### count length of hospitalization throughout time frame 
##### Flawed approac-- actually need to look at first & last day

ibs_dat %>% group_by(conf_num) %>% summarise(distinct_days = n_distinct(from_dt))

length(unique(ibs_dat$from_dt))
```

Starting to group together bloodwork, imaging, surgery, colonoscopy, prescription claims
```{r}
events_timeline_procedure <- ibs_dat %>% 
  # IBS-- need to include this separately because of possibility of overwriting
  #mutate(event_type = ifelse(Primary_diag == "Irritable Bowel Syndrome", "IBS_diagnosis", NA)) %>%
  
  ### Create event_type as column of NAs
  mutate(event_type = NA) %>%
  
  mutate(event_type = case_when(
    grepl("emergency department", PROCEDURE_DESC, ignore.case = TRUE) ~ "ED_visit",
    grepl("colonoscopy", PROCEDURE_DESC, ignore.case = TRUE) ~ "colonoscopy",
    grepl("Esophagogastroduodenoscopy", 
          PROCEDURE_DESC, ignore.case = TRUE) ~ "esophagogastroduodenoscopy",
    (grepl("Enterectomy", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("Enterostomy", PROCEDURE_DESC, ignore.case = TRUE)) ~ "surgery",
    (grepl("ultrasound", PROCEDURE_DESC, ignore.case = TRUE) | 
       grepl("tomography", PROCEDURE_DESC, ignore.case = TRUE) ~ "imaging")))

```

Want to group data within 3 day intervals to categorize that as one visit
```{r}
#so all the points that are 3 days or less apart are put into one group
## want to exclude hospitalizations bc those are a single visit (if conf_num exists = hospitalization)
```


Create new column for labs & imaging
```{r}
library(dplyr)
library(ggplot2)
library(lubridate)

ibs_dat$lab <- 0
ibs_dat$imaging <- 0

ibs_lab_image <- ibs_dat %>%
  
  ## group the labs
  mutate(lab = case_when(
    ## CBC w/ diff
    proc_cde ==  "85025" ~ "cbc_w_diff",
    
      ## C reactive protein
    proc_cde == "86140" ~ "c_reactive_protein",  
      
    ## Erythrocyte sedimentation rate
    proc_cde == "85651" | 
    proc_cde == "85652" ~ "erythrocyte_sed_rate",
    
    ## Albumin
    proc_cde == "82040" ~ "albumin",
    
    ## AST
    proc_cde == "84450" ~ "ast", 
    
    ## ALT
    proc_cde == "84460" ~ "alt", 
    
    ## Total protein
    proc_cde == "84155" ~"total_protein")) %>%


  mutate(imaging = case_when(
    
    ## CT abdomen w/ & w/o contrast
    proc_cde == "74170" ~ "ct_abdomen_w_wo_contrast",
    
    ## CT abdomen & pelvis w/o contrast
    proc_cde == "74176"  ~ "ct_abdomen_pelvis_wo_contrast",
    
    ## CT abdomen & pelvis w/ contrast 
    proc_cde == "74177" ~ "ct_abdomen_pelvis_w_contrast",
    
    ## MRI abdomen
    proc_cde == "74183" ~ "mri_abdomen",
    
    ## MR enterography
    proc_cde == "74181"|
    proc_cde == "74182" |
    proc_cde == "74183"|
    proc_cde == "72195" |
    proc_cde == "72196"|
    proc_cde == "72197" ~ "mr_enterography",
    
    ## Xray abdomen
    proc_cde == "74018" ~ "xray_abdomen" ))



### create visuals for frequency
# First subset for when labs occurred (no NAs), then group by from_dt
ibs_lab_image %>% filter(lab != "NA") %>% group_by(from_dt, lab, claimno) %>%
  tally %>% mutate(month_day = format(from_dt, "%m-%d"),
                   year = format(from_dt, "%Y"), month = format(from_dt, "%m"))


########################## Xian questions about same lab same day
##### Row 3 & 4


ibs_lab_image %>% filter(claimno == "joc8egbu3momuwp1") %>% filter(lab != "NA")
## Rectype A: Procedures for ancillary services or any other procedures or services that did not meet criteria of other record type assignments. Oftentimes, these are records associated with laboratory testing.
## ptypeflg: 1--  clinician or facility provider (i.e. ptypeflg is 0 or 1) 
## proc_cde: 85025
## bill_spec: OTHER (vs pathol-- don't have key for this)
## rend_spec: OTHER


ibs_lab_image %>% filter(claimno == "vhfzr70yn4093yvn") %>% filter(lab != "NA")
## Rectype A: Procedures for ancillary services or any other procedures or services that did not meet criteria of other record type assignments 
## proc_cde: 85025
# From dt 07/16-- to dt 07-17... but not an inpatient visit bc not hospitalization & tos_flg == 0
## ptypeflg: 0--  clinician or facility provider (i.e. ptypeflg is 0 or 1)
## bill_spec: PATHOL
## rend_spec: PATHOL


#### last 2 rows
ibs_lab_image %>% filter(claimno == "7b69cj7qrqvly23c") %>% filter(lab != "NA")
## Rectype A
## proc_cde: 85025
## ptypeflg: 0--  clinician or facility provider (i.e. ptypeflg is 0 or 1)
## bill_spec: PATHOL
## rend_spec: PATHOL
## diag1 code: 	5770

# ^ primary diagnosis was acute pancreatitis

ibs_lab_image %>% filter(claimno == "fhkulqp0i5mc223d") %>% filter(lab != "NA")

### dif primary diagnosis-- abnormal chest sounds
## Rectype A
## proc_cde: 85025
## ptypeflg: 0--  clinician or facility provider (i.e. ptypeflg is 0 or 1)
## bill_spec: PATHOL
## rend_spec: PATHOL
## diag1 code: 	7867

ibs_dat %>% filter(claimno == "vhfzr70yn4093yvn") %>% filter(proc_cde == "85025")


### CLaim joc8egbu3momuwp1 occured on 2011-07-16 w/ proc_cde 85025

### Claim vhfzr70yn4093yvn occured on 2011-07-16

```

Comparing singular patient to 4 patients 
```{r}
##### IBS/IBD/Crohn's diagnosis for new patients 
####### note: many w/ other potentially interesting diagnoses that don't contain those keywords
dat_4pts %>% filter(grepl('crohn|irritable', Primary_diag, ignore.case = TRUE)) %>% group_by(from_dt, PAT_ID, Primary_diag) %>% tally()


### ED visit info by searching the PROCEDURE_DESC for instances of "emergency department" for that one patient 
dat_4pts %>% filter(PAT_ID == '05imadm9fhf0idl5') %>% filter(grepl("surgical|colectomy", PROCEDURE_DESC, ignore.case = TRUE)) %>%
  group_by(from_dt)


## Get hospitalization lengths
# first subset to the hospitalizations, then group by hospitalization code
# then order by from_dt and tally to see the number of claims on each unique date
# find difference between the first claim date and last claim date + 1 for each unique hospitalization to get total length

# only run before ### to get table w/ unique lengths
# for better graphics, need to mutate into year & month to capture time frame

hosp_duration <- dat_4pts %>% filter(PAT_ID == '05imadm9fhf0idl5') %>% filter(!is.na(conf_num)) %>% 
  group_by(conf_num, from_dt) %>% arrange(from_dt) %>% tally() %>% #only include the distinct() line for small table
  mutate(hosp_length = max(ymd(from_dt)) - min(ymd(from_dt)) + 1) %>% # distinct(conf_num, hosp_length) ####
  distinct(from_dt, .keep_all = TRUE) %>% mutate(month_day = format(from_dt, "%m-%d"),
                                               year = format(from_dt, "%Y"))



ggplot(data = hosp_duration, 
       aes(x = month_day, y = as.numeric(hosp_length), fill = conf_num)) + 
  geom_bar(stat='identity') + labs(title ="Hospitalizations by Month in 2017",
       x = "Month", y = "Hospitalization Length (Days)")


### Now view unique claims for outpatient vs inpatient 
##### inpatient visuals

## pull out inpatient AKA hospitalizations (Have conf_num code) data, remember to filter just for this singular patient
inpatient <- dat_4pts %>% filter(PAT_ID == '05imadm9fhf0idl5') %>% filter(!is.na(conf_num))

# These are the distinct visit dates/distinct claims
inpatient_visits <- inpatient %>%  distinct(from_dt, .keep_all = TRUE) %>% 
  arrange(ymd(.$from_dt)) %>%
  group_by(from_dt, claimno) %>%
  tally


# graph of above for individual visit frequency
## Create plot with unique "from_dt" as x-axis, number of unique visits per date 

ggplot(data = inpatient_visits, aes(x = from_dt, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title ="Unique Inpatient Visit Claims",
       x = "Date", y = "Claims") + ylim(0, 3)

#### outpatient visuals (non-pharmacy)

# get rid of pharmacy claims which have NDC codes

outpatient <- dat_4pts %>% filter(PAT_ID == '05imadm9fhf0idl5') %>% filter(is.na(conf_num)) %>% filter(is.na(ndc))

## Visualize total outpatient claims
#### There are 220 total rows for this, but only 40 unique claims (distinct dates)

# These are the distinct visit dates/distinct claims
outpatient_visits <- outpatient %>%  distinct(from_dt, .keep_all = TRUE) %>% 
  arrange(ymd(.$from_dt)) %>%
  group_by(from_dt, claimno) %>%
  tally


# graph of above for individual visit frequency
## Create plot with unique "from_dt" as x-axis, number of unique visits per date 

ggplot(data = outpatient_visits, aes(x = from_dt, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title ="Unique Outpatient Visit Claims",
       x = "Date", y = "Claims") + ylim(0, 5)


######### re-run w/ the read_data to add the group columns to plot "ibs_grouped" is the data that has these
#### Create plot with unique "from_dt" as x-axis, number of TOTAL claims as y-axis, color by the group
## also facet by year 

### unique claims & counts per date
group_claim_cts <- ibs_grouped %>% arrange(ymd(dat_4pts$from_dt)) %>% distinct(from_dt, .keep_all = TRUE) %>%
  filter(PAT_ID == '05imadm9fhf0idl5') %>% 
  # filter(is.na(ndc)) %>% #### Comment this out to include prescriptions
  group_by(from_dt, claimno, group) %>%
  tally %>% mutate(month_day = format(from_dt, "%m-%d"),
                   year = format(from_dt, "%Y"), month = format(from_dt, "%m"))

########## This graph isn't that helpful and needs to be broken down 
ggplot(data = group_claim_cts, aes(x = month_day, y = n, colour = group)) +
  geom_bar(stat = "identity", aes(fill = group)) +
  labs(title ="Total Number of Claims (non-unique) per visit date",
       x = "Month", y = "Number of Unique Claims") + facet_grid(facets = year ~ .) +
  ## not including prescriptions
   # scale_x_discrete("month_day", c("01-17", "02-19", "03-13", "04-14", "05-18", 
                               #   "06-15", "07-16", "08-19", "09-14", "10-17", "11-17", "12-13")) 

  ## for including prescriptions
  scale_x_discrete("month_day", c("01-17", "02-17", "03-17", "04-18", "05-18", 
                                  "06-17", "07-16", "08-19", "09-14", "10-17", "11-17", "12-13"))



#### Now looking at lab analysis & drug analysis
## Create a new dataset for drug_name & drug_class
 ########## re-run tthe read_data step to get the drug classes & drug names 

## visuals
# First wrangle data to get the visits dates, drug class, drugs used
# These are the distinct visit, drug class, and drug used-- only ones that have NDC codes
drug_usage <- ibs_drug_class %>%  filter(PAT_ID == '05imadm9fhf0idl5') %>% distinct(from_dt, .keep_all = TRUE) %>% 
  arrange(ymd(.$from_dt)) %>% filter(ndc != "NA") %>%
  group_by(drug_class, drug_name, from_dt, claimno) %>%
  tally %>% mutate(month_day = format(from_dt, "%m-%d"),
                   year = format(from_dt, "%Y"), month = format(from_dt, "%m"))


# by drug name

ggplot(data = drug_usage, aes(x = month_day, y = n, colour = drug_name)) +
  geom_bar(stat = "identity", aes(fill =  drug_name)) +
  labs(title ="Drug Name Prescribed per visit date by Year",
       x = "Date", y = "Claims") + ylim(0, 3) + facet_grid(facets = year ~ .) +
  scale_x_discrete("month_day", c("01-17", "02-17", "03-17", "04-18", "05-18", 
                                  "06-17", "07-16", "08-19", "09-14", "10-17", "11-17", "12-13"))


# by drug class 
ggplot(data = drug_usage, aes(x = month_day, y = n, colour = drug_class)) +
  geom_bar(stat = "identity", aes(fill =  drug_class)) +
  labs(title ="Drug Class Prescribed per visit date by Year",
       x = "Date", y = "Claims") + ylim(0, 3) + scale_fill_manual(values = c("orange", "blue", "gray")) + scale_colour_manual(values = c("orange", "blue", "gray")) + facet_grid(facets = year ~ .) +
  scale_x_discrete("month_day", c("01-17", "02-17", "03-17", "04-18", "05-18", 
                                  "06-17", "07-16", "08-19", "09-14", "10-17", "11-17", "12-13"))

```


Slide 26 analysis 
```{r}

## patient analysis 05imadm9fhf0idl5 

ibs_lab_image %>% filter(PAT_ID == "05imadm9fhf0idl5") %>%
  filter(grepl('crohn|irritable', Primary_diag, ignore.case = TRUE)) %>% filter(from_dt == as.POSIXct("2017-04-08", tz = "UTC") ) 
```

### 12/07 meeting

Working to bundle visits -- cumulative percentage curve
```{r}
setwd("/Users/janeshe/Desktop/RL_IBS")
source('Scripts/visit_grouping.R')


######## use frequency curve to visualize and find cutoffs ###########
num_freq <- outpatient %>% select(pat_id, from_dt, between_dt)%>% 
  group_by(between_dt) %>% count() %>% na.omit()
names(num_freq) <- c("days_between_visits", "count")

# create percentages
num_freq <- num_freq %>% arrange(days_between_visits) %>% mutate(percent = count/ sum(num_freq$count))
num_freq$cumulative_percentage <- cumsum(num_freq$percent)


## plot cumulative percentage
library(ggplot2)

#cumulative plot
ggplot(data = num_freq, aes(x = days_between_visits, y = cumulative_percentage)) + geom_point() + geom_line() + geom_smooth() + xlim(0,30)


### double checking with our overall frequency bar graph with a smoothing line

ggplot(frequency, aes(x=between_dt)) + geom_histogram(aes(y = ..density..), binwidth=1) + xlim(0,15) + geom_density()
#xlim(0, 15)

```

```{r}
## trying to identify visits that had a bunch of consecutive visits, that the code would just count as a single visit since each biling date was less than 4 days apart (our preliminary definition) from the next visit

## using outpatient data, just select a few columns
outpatient %>% select(pat_id, date, between_dt, group, drug_name, drug_class, visit_group) %>%
  #group by patient ID, then group by visit group
  group_by(pat_id, visit_group) %>%
  #sort by earliest to most recent date within each visit group
  arrange(date, .by_group = TRUE) %>% 
  # within each visit group, calculate the number of days between the current and the first date
  mutate(within_group_day_difference = as.numeric(date - min(date))) %>%
  select(pat_id, date, visit_group, within_group_day_difference, group) %>% filter(pat_id == "o85jims6dec0sb8v") %>% View()

#### code works, just look at above example ^^
## group can be prescription, labs, or imaging

```

